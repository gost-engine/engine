name: CI
on:
    push:
    pull_request:
    schedule:
        - cron: '0 2 * * 0'

env:
    OPENSSL_BRANCH: openssl-3.6.0
    USE_RPATH: yes
    PATCH_OPENSSL: 0
    GOST_PROVIDER_ENABLE_ONLINE_TESTS: 1

jobs:
    gcc-openssl-stable:
        runs-on: ubuntu-latest
        if: ${{ github.event_name != 'schedule' }}
        env:
            PATCH_OPENSSL: 1
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    clang-openssl-stable:
        runs-on: ubuntu-latest
        if: ${{ github.event_name != 'schedule' }}
        env:
            CC: clang
            PATCH_OPENSSL: 1
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    macos-openssl-stable:
        runs-on: macos-latest
        if: ${{ github.event_name != 'schedule' }}
        env:
            USE_RPATH:
            PATCH_OPENSSL: 1
            GOST_PROVIDER_ENABLE_ONLINE_TESTS: 0 # macOS runner has no network access to infotecs TLS1.3 server
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    gcc-openssl-master:
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'schedule' }}
        env:
            OPENSSL_BRANCH: master
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    macos-openssl-master:
        runs-on: macos-latest
        if: ${{ github.event_name == 'schedule' }}
        env:
            OPENSSL_BRANCH: master
            USE_RPATH:
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    gcc-asan-openssl-master:
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'schedule' }}
        env:
            OPENSSL_BRANCH: master
            ASAN: -DASAN=1
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    macos-asan-openssl-master:
        runs-on: macos-latest
        if: ${{ github.event_name == 'schedule' }}
        env:
            OPENSSL_BRANCH: master
            ASAN: -DASAN=1
            USE_RPATH:
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

    gcc-openssl-stable-x86:
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'schedule' }}
        env:
            CFLAGS: -m32
            LDFLAGS: -m32
            SETARCH: "setarch i386"
            APT_INSTALL: gcc-multilib
            PATCH_OPENSSL: 1
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: true
            - run: .github/before_script.sh
            - run: .github/script.sh

